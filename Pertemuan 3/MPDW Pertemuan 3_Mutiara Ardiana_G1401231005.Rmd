---
title: "MPDW - Pertemuan 3"
author: "Mutiara Ardiana"
date: "`r Sys.Date()`"
output:
  html_document:
    rmdformats::readthedown
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Library

```{r}
library(readxl)
library(dplyr)
library(janitor)
library(ggplot2)
library(zoo)        
library(dynlm)     
library(lmtest)    
library(tseries)  
library(sandwich) 
library(forecast)
library(dLagM)
library(dynlm)
library(MLmetrics)
library(car)
library(rio)
```

# **Data**

## Pemilihan Peubah X dan Peubah Y

```{r}
data_full <- rio::import("C:/Users/MUTIARA ARDIANA/OneDrive/Desktop/SEMESTER 5/[3] MPDW/3 MPDW/AQI New Delhi.xlsx", sheet = 1)
str(data_full)
data_full
```

Dalam penelitian ini, **PM2.5** akan dipilih sebagai **peubah penjelas (xt)** untuk memodelkan **AQI (yt)**. Keputusan ini didasarkan pada temuan studi *Implementation of Random Forest Algorithm for Air Quality Classification: A Case Study of DKI Jakarta’s Air Quality Index* (2025),yang menunjukkan bahwa komponen partikulat mendominasi pembentukan AQI di DKI Jakarta, dengan **PM2.5** menyumbang pengaruh terbesar (**46,62%**), disusul **PM10** (**32,08%**). Dengan pertimbangan ilmiah dan bukti empiris tersebut, kami menetapkan pemetaan variabel sebagai berikut:

**`t`** = indeks jam pengamatan

`Yt` = nilai AQI pada jam ke-t

`Yt-1` = lag 1 jam AQI

`Xt` = kadar PM2.5 pada jam yang sama

**Link Jurnal:** [Implementation of Random Forest Algorithm for Air Quality Classification: A Case Study of DKI Jakarta's Air Quality Index (2025)](https://www.ijisrt.com/assets/upload/files/IJISRT25MAR1548.pdf)

## Data Pakai

```{r}
data <- rio::import("C:/Users/MUTIARA ARDIANA/OneDrive/Desktop/SEMESTER 5/[3] MPDW/3 MPDW/AQI New Delhi.xlsx", sheet = 2)
str(data)
data
```

```{r}
names(data)

data <- data |>
  mutate(
    "Yt" = as.numeric(Yt),
    "Yt-1" = as.numeric(Yt-1),
    "Xt" = as.numeric(Xt)
  ) |>
  filter(!is.na(Yt) & !is.na(Xt)) 
nrow(data)
```

# EDA

```{r}
summary(data[, c("Yt", "Xt")])
```

```{r}
autoplot_ts <- function(y, ttl) {
  ggplot(data.frame(t = seq_along(y), y = y),
         aes(t, y)) + geom_line() +
    labs(x = "t", y = ttl, title = ttl) + theme_minimal()
}
autoplot_ts(data$Yt, "Yt (AQI)")
autoplot_ts(data$Xt, "Xt (Polutan)")
```

```{r}
ggplot(data, aes(x = Xt, y = Yt)) +
  geom_point() + geom_smooth(method = "lm", se = FALSE) +
  labs(title="Scatter Y vs X", x = "Xt", y = "Yt") + theme_minimal()
```

```{r}
acf(data$Yt, main="ACF Yt")
pacf(data$Yt, main="PACF Yt")
acf(data$Xt, main="ACF Xt")
pacf(data$Xt, main="PACF Xt")
```

```{r}
adf.test(na.omit(data$Yt))  
adf.test(na.omit(data$Yt))

```

Stasioner

### Eksplorasi Kondisi Gauss-Markov

```{r}
model <- lm(Yt ~ Xt, data = data)
model
summary(model)
```

```{r}
# Residual & fitted
res <- resid(model); fit <- fitted(model)
```

```{r}
# (1) E(u)=0 ?
mean(res)
```

```{r}
# (2) Homoskedastisitas: plot & uji Breusch–Pagan
plot(fit, res, xlab="Fitted", ylab="Residual", main="Residual vs Fitted"); abline(h=0, col="red")
bptest(model)
```

```{r}
# (3) Autokorelasi residual: ACF & uji Durbin–Watson / Breusch–Godfrey
acf(res, main="ACF Residual OLS")
dwtest(model)               # autokorelasi lag-1
bgtest(model, order=12)  
```

```{r}
library(lmtest); library(sandwich)
coeftest(model, vcov = NeweyWest(model, lag = 12, prewhite = FALSE))
```

**Kesimpulan:**

Berdasarkan eksplorasi kondisi Gauss-Markov, diperoleh bahwa model regresi linier sederhana $Y_t$ \~ $X_t$ ​belum mampu menjelaskan dinamika AQI secara memadai. Secara rata-rata, residual sudah mendekati nol sehingga asumsi ekspektasi error terpenuhi. Namun, dua asumsi penting Gauss–Markov dilanggar:

1.  **Heteroskedastisitas:** Hasil uji Breusch–Pagan menunjukkan nilai BP yang sangat signifikan (p \< 0.001), sehingga varians error tidak konstan. Hal ini menandakan adanya ketidakstabilan sebaran residual.

<!-- -->

2.  **Autokorelasi:** Uji Durbin–Watson maupun Breusch–Godfrey menegaskan adanya autokorelasi residual hingga beberapa lag. Plot ACF residual juga memperlihatkan pola korelasi yang jelas antar periode.

    Kondisi ini menyebabkan estimator OLS masih bersifat unbiased, tetapi tidak lagi efisien, dan uji signifikansi dengan standar error biasa menjadi tidak valid. Ketika dilakukan koreksi dengan **Newey–West (HAC)**, hasilnya menunjukkan bahwa pengaruh variabel $X_t$ ​ terhadap $Y_t$ tidak signifikan secara statistik. Artinya, variasi AQI lebih banyak ditentukan oleh dinamika dirinya sendiri (lag $Y$) dibandingkan oleh hubungan kontemporer dengan polutan $X_t$​.

    Temuan ini memberikan landasan kuat untuk beralih dari model OLS sederhana menuju **pemodelan deret waktu dinamis** yang dapat mengakomodasi memori data dan pola autokorelasi. Beberapa model kandidat yang relevan untuk dieksplorasi lebih lanjut adalah:

    -   **Model Koyck** (memasukkan $Y_{t-1}$ dan $X_t$ )

    -   **Distributed Lag Model** (memasukkan $X_t$​ beserta beberapa lag X)

    -   **Autoregressive Model (AR)** (memasukkan lag Y saja)

    Ketiga model ini akan dibandingkan kinerjanya, khususnya dengan ukuran akurasi prediksi seperti **Mean Absolute Percentage Error (MAPE)** pada data uji, untuk menemukan model terbaik yang paling tepat merepresentasikan dinamika AQI.

# Pembagian Data

```{r}
# SPLIT DATA
train <- data[1:58,]
test <- data[58:72,]

#data time series
train.ts <- ts(train)
test.ts <- ts(test)
data.ts <- ts(data)
```

# Pemodelan

## Model Koyck

```{r, eval = FALSE, message = FALSE, warning = FALSE, error = FALSE}
#koyckDlm(x , y , intercept)
```

```{r}
model.koyck <- koyckDlm(x = train$Xt, y = train$Yt)
summary(model.koyck)
AIC(model.koyck)
BIC(model.koyck)
```

**Interpretasi Hasil:**

-   Dari `summary`, kita dapatkan model:

    $$ \hat{Y_t}=4.0771-0.5723X_t+0.8897Y_{t-1} $$

    Koefisien $X_t$ (-0.5723) signifikan, artinya nilai $X$ saat ini berpengaruh terhadap $Y$.

-   Koefisien $Y_{t−1}$ (0.8897) juga signifikan. Ini adalah **estimasi untuk** $\lambda$. Nilai ini menunjukkan bahwa sekitar 88% dari efek di periode sebelumnya masih "terbawa" ke periode saat ini.

### Peramalan dan Akurasi

Berikut adalah hasil peramalan $Y$ untuk 15 periode kedepan menggunakan Model Koyck.

```{r}
fore.koyck <- forecast(model = model.koyck, x = test$Xt, h = 15)
fore.koyck
mape.koyck <- MAPE(fore.koyck$forecasts, test$Yt)
mape.koyck #data test
#akurasi data training
GoF(model.koyck)
```

## Regressive with Distributed Lag

### Pemilihan Lag Awal

```{r}
ccf(train$Xt, train$Yt, lag.max = 12, main="CCF Xt vs Yt (train)")
```

### Lag Optimum

Lag paling optimum akan dicari berdasarkan kriteria informasi seperti AIC (Akaike Information Criterion). AIC menyeimbangkan antara kecocokan model dengan kompleksitasnya.

```{r}
#penentuan lag optimum 
finiteDLMauto(formula = Yt ~ Xt,
              data = data.frame(train), q.min = 1, q.max = 6, model.type = "dlm", error.type = "AIC", trace = TRUE)
```

Berdasarkan output tersebut, lag optimum didapatkan ketika lag = 6. Selanjutnya dilakukan pemodelan untuk lag = 6.

```{r}
#model dlm dengan lag optimum
model.dlm <- dlm(x = train$Xt,y = train$Yt , q = 6)
summary(model.dlm)
```

Dari hasil tersebut terdapat peubah yang berpengaruh signifikan terhadap taraf nyata 5% yaitu $x_t$ . Adapun keseluruhan model yang terbentuk adalah

$$\hat{Y_t}=37.8700-12.0761X_t$$

Adapun hasil peramalan 15 periode kedepan menggunakan model tersebut adalah sebagai berikut

```{r}
#peramalan dan akurasi
fore.dlm <- forecast(model = model.dlm, x = test$Xt, h = 15)

#akurasi data test
mape.dlm<- MAPE(fore.dlm$forecasts, test$Yt)
mape.dlm

#akurasi data training
GoF(model.dlm)
```

Model tersebut merupakan model yang sangat baik dengan nilai MAPE yang kurang dari 10%.

# Model Autoregressive

```{r}
# cari nilai p
library(dynlm)

aics <- sapply(1:6, function(pp){
  fm <- dynlm(Yt ~ L(Yt, 1:pp), data = train.ts)
  AIC(fm)
})
data.frame(p = 1:6, AIC = aics)
```

```{r}
model.ardl <- ardlDlm(x = train$Xt, y = train$Yt, p = 6 , q = 6)
summary(model.ardl)
AIC(model.ardl)
BIC(model.ardl)
```

```{r}
model.ardl <- ardlDlm(formula = Yt ~ Xt, 
                         data = train,p = 6 , q = 6)
summary(model.ardl)
AIC(model.ardl)
BIC(model.ardl)
```

## Peramalan dan Akurasi

```{r}
fore.ardl <- forecast(model = model.ardl, x= test$Xt, h = 15)
fore.ardl
```

```{r}
mape.ardl <- MAPE(fore.ardl$forecasts, test$Yt)
mape.ardl
#akurasi data training
GoF(model.ardl)
```

## Lag Optimum

```{r}
#penentuan lag optimum
model.ardl.opt <- ardlBoundOrders(data = data.frame(data), ic = "AIC", 
                                  formula = Yt ~ Xt )
model.ardl.opt
min_p=c()
for(i in 1:6){
  min_p[i]=min(model.ardl.opt$Stat.table[[i]])
}
q_opt=which(min_p==min(min_p, na.rm = TRUE))
p_opt=which(model.ardl.opt$Stat.table[[q_opt]] == 
              min(model.ardl.opt$Stat.table[[q_opt]], na.rm = TRUE))
data.frame("q_optimum" = q_opt, "p_optimum" = p_opt, 
           "AIC"=model.ardl.opt$min.Stat)
```

```{r}
model.ardl2 <- ardlDlm(formula = Yt ~ Xt, 
                         data = train,p = 5, q = 15)
summary(model.ardl2)
AIC(model.ardl2)
```

Dari tabel di atas, dapat terlihat bahwa nilai AIC terendah didapat ketika $p = 15$ dan $q = 5$, yaitu sebesar `124.7089`. Artinya, model autoregressive optimum didapat ketika $p = 15$ dan $q = 5$.

# Perbandingan Model

```{r}
akurasi <- matrix(c(mape.koyck, mape.dlm, mape.ardl))
row.names(akurasi)<- c("Koyck","DLM","Autoregressive")
colnames(akurasi) <- c("MAPE")
akurasi
```

Berdasarkan nilai MAPE, model paling optimum didapat pada Model Koyck karena memiliki nilai MAPE yang terkecil.
